<!DOCTYPE html>
<html>
	<head>
		<style type="text/css">
			audio {
				width: 100%;
				height: 100%;
			}
		</style>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="https://golden-layout.com/files/latest/js/goldenlayout.min.js"></script>
		<link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-base.css" />
		<link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-dark-theme.css" />
		<style type="text/css">
			.lm_content {
				color: white;
			}
			#mediaPlayerContainer {
				width: 100%;
				height: 100%;
			}
			video {
				width: 100%;
				height: 100%;
			}
			#songList {
				width: 100%;
				height: 100%;
				overflow-y: auto;
				overflow-x: hidden;
			}
			#songList li {
				cursor: pointer;
			}
			#currentlyPlaying dt {
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">
			$(document).ready(function () {
				'use strict';
				var $songList = $('#songList');
				var $audioPlayer = $('#audioPlayer');
				var songDB = {};
				var currentSong = {
					path: null
				};
				var goldenLayoutConfig = {
					settings: {
						showPopoutIcon: false,
						showCloseIcon: false,
					},
					content: [{
						type: 'column',
						content: [{
							type: 'component',
							componentName: 'mediaPlayer',
							height: 30,
						}, {
							type: 'row',
							content: [{
								type: 'component',
								componentName: 'songList',
								width: 70,
							},{
								type: 'component',
								componentName: 'currentlyPlaying',
							}]
						}]
					}]
				};
				var myLayout = new GoldenLayout(goldenLayoutConfig);
				myLayout.registerComponent('mediaPlayer', function(container, componentState) {
					var $root = $('<div id="mediaPlayerContainer">');
					var $video = $('<video controls autoplay preload="auto">Your browser does not support the <code>video</code> element.</video>');
					$root.append($video);
					container.getElement().append($root);
					Object.observe(currentSong, function() {
						var url;
						var foundWorkaroundForLoadingLocalResourcesInWebServer = false;
						if (foundWorkaroundForLoadingLocalResourcesInWebServer &&
							'localhost' === window.location.hostname) {
							url = 'file://' + encodeURI(currentSong['path']);
						} else {
							url = '/api/1/songs/binary?songPath=' + encodeURIComponent(currentSong['path']);
						}
						$video.attr('src', url);
					});
					$video.on('ended', function(e) {
						var keys = Object.keys(songDB);
						var randomKey = keys[Math.floor(Math.random() * keys.length)];
						var selectedSong = songDB[randomKey];
						for (var key in selectedSong) {
							currentSong[key] = selectedSong[key];
						}
					});
				});
				myLayout.registerComponent('songList', function(container, componentState) {
					var $root = $('<div id="songList">');
					$root.text("Loading song list...")
					container.getElement().append($root);
					$root.on('click', 'li', function(e) {
						var $li = $(e.target);
						var selectedSong = songDB[$li.data('id')];
						for (var key in selectedSong) {
							currentSong[key] = selectedSong[key];
						}
					});
					Object.observe(songDB, function() {
						var $ul = $('<ul>');
						var html = '<ul>';
						for (var key in songDB) {
							var $li = $('<li>');
							$li.data('id', key);
							$li.text(songDB[key].path);
							$ul.append($li);
						}
						$root.empty();
						$root.append($ul);
					});
				});
				myLayout.registerComponent('currentlyPlaying', function(container, componentState) {
					var $root = $('<div id="currentlyPlaying">');
					var $dl = $('<dl>');
					$root.append($dl);
					container.getElement().append($root);
					Object.observe(currentSong, function() {
						$dl.empty();
						for (var key in currentSong) {
							var $dt = $('<dt>');
							$dt.text(key);
							$dl.append($dt);
							var $dd = $('<dd>');
							$dd.text(currentSong[key]);
							$dl.append($dd);
						}
					});
				});
				myLayout.init();
				$.ajax('/api/1/songs/').done(function(data, textStatus, jqXHR) {
					for (var key in data) {
						songDB[key] = data[key];
					}
				});
				$songList.on('click', 'li', function(e) {
					var $li = $(e.target);
					var url = '/api/1/song?songPath=' + encodeURIComponent($li.data('path'));
					console.log(url);
					$audioPlayer.attr('src', url);
				});
				
			});
		</script>
	</body>
</html>